name: C/C++ CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: CheckOut
      uses: actions/checkout@v1

    - name: Install Dependencies [Linux]
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install cmake libsdl2-dev
    - name: Install Dependencies [Darwin]
      if: matrix.os == 'macos-latest'
      run: |
        export HOMEBREW_NO_INSTALL_CLEANUP=1
        brew update
        # cmake is preinstalled, trying to install it again will error out
        brew install sdl2
    - name: Install Dependencies [Windows]
      if: matrix.os == 'windows-latest'
      run: |
        pushd ..
        git clone https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        .\bootstrap-vcpkg.bat
        .\vcpkg.exe install sdl2:x64-windows vcpkg-cmake-config:x64-windows vcpkg-cmake:x64-windows
        popd

    - name: Configure [Linux]
      if: matrix.os == 'ubuntu-latest'
      run: |
        mkdir build && cd build
        cmake -D CMAKE_BUILD_TYPE=Release ..
    - name: Configure [Darwin]
      if: matrix.os == 'macos-latest'
      run: |
        mkdir build && cd build
        cmake -D CMAKE_BUILD_TYPE=Release ..
    - name: Configure [Windows]
      if: matrix.os == 'windows-latest'
      run: |
        mkdir build && cd build
        cmake -D CMAKE_BUILD_TYPE=Release -D CMAKE_TOOLCHAIN_FILE=../vcpkg/scripts/buildsystems/vcpkg.cmake ..

    - name: Build [Linux]
      if: matrix.os == 'ubuntu-latest'
      run: |
        make -C build pmdplay
    - name: Build [Darwin]
      if: matrix.os == 'macos-latest'
      run: |
        make -C build pmdplay
    - name: Build [Windows]
      if: matrix.os == 'windows-latest'
      run: |
        cmake --build . --config Release --target pmdplay

    - name: Check
      run: |
        cd build
        echo "Checking if pmdplay works: ./pmdplay ../PC-98_Hartmann_s_Youkai_GIrl.M PC-98_Hartmann_s_Youkai_GIrl.wav"
        ./pmdplay ../PC-98_Hartmann_s_Youkai_GIrl.M PC-98_Hartmann_s_Youkai_GIrl.wav
